language:
- objective-c

env:
  matrix:
  - VERSION=2.7.9
  - VERSION=3.3.5
  - VERSION=3.4.2

install:
# increase number of open files allowed for tests
# https://github.com/matplotlib/matplotlib/issues/3315
- ulimit -n 4096
- source run_install.sh
- get_python_environment macpython $VERSION venv
- check_var $BUILD_PREFIX
- check_var $SYS_CC
- check_var $SYS_CXX
- check_var $PYTHON_EXE
- ls
- cd pywikibot-core
- echo '[directories]' >> setup.cfg
- echo "basedirlist = $BUILD_PREFIX, /usr" >> setup.cfg
- mkdir ~/.pywikibot
- touch ~/.pywikibot/user-config.py
- echo "max_retries = 2" >> ~/.pywikibot/user-config.py
- echo "maximum_GET_length = 5000" >> ~/.pywikibot/user-config.py
- echo "console_encoding = 'utf8'" >> ~/.pywikibot/user-config.py
- FAMILY=wikipedia
- LANGUAGE=en
- if [[ -n "$USER_PASSWORD" && -n "$PYWIKIBOT2_USERNAME" ]]; then
    echo "usernames['$FAMILY']['$LANGUAGE'] = '$PYWIKIBOT2_USERNAME'" >> ~/.pywikibot/user-config.py ;
    echo "usernames['wikipedia']['en'] = '$PYWIKIBOT2_USERNAME'" >> ~/.pywikibot/user-config.py ;
    echo "usernames['wikipedia']['test'] = '$PYWIKIBOT2_USERNAME'" >> ~/.pywikibot/user-config.py ;
    echo "usernames['wikidata']['test'] = '$PYWIKIBOT2_USERNAME'" >> ~/.pywikibot/user-config.py ;
    echo "usernames['commons']['commons'] = '$PYWIKIBOT2_USERNAME'" >> ~/.pywikibot/user-config.py ;
    echo "('$PYWIKIBOT2_USERNAME', '$USER_PASSWORD')" > ~/.pywikibot/passwordfile ;
  fi
- cat ~/.pywikibot/user-config.py
- cat ~/.pywikibot/passwordfile
- CC=${SYS_CC} CXX=${SYS_CXX} python setup.py install

script:
# Fix numpy ast errors in tests by upgrading numpy
- $PYTHON_EXE setup.py test
